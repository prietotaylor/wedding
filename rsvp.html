<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSVP</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Small additions that fit your theme */
    #status, #lookupError, #saveError, #saveSuccess { margin-top: 0.75rem; }
    #lookupError, #saveError { font-weight: 700; }
    #saveSuccess { font-weight: 700; }

    .guest {
      width: 100%;
      border: 1px solid #000;
      background: #fff;
      padding: 1rem;
      margin-top: 1rem;
      text-align: left;
    }
    .guest h2 {
      font-size: 1rem;
      margin: 0 0 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .guest .attending {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin: 0.5rem 0 1rem;
      letter-spacing: 0.05em;
    }
    .guest label { display: block; margin-top: 0.75rem; font-weight: 600; letter-spacing: 0.05em; }
    .guest textarea {
      width: min(680px, 100%);
      border: 1px solid #000;
      font-family: inherit;
      font-size: 1rem;
      letter-spacing: 0.05em;
      padding: 0.75rem;
      margin-top: 0.35rem;
      min-height: 72px;
    }

    /* Make the RSVP action buttons follow your form button look */
    #rsvpActions button { width: min(340px, 100%); }
  </style>
</head>

<body>
  <div class="page" id="rsvp">
    <h1>RSVP</h1>
    <p>please enter your first and last name and zip code to enter or update your response</p>

    <form id="lookupForm" novalidate>
      <input id="firstName" type="text" autocomplete="given-name" placeholder="first name" />
      <input id="lastName" type="text" autocomplete="family-name" placeholder="last name" />
      <input id="zip" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="zip code" />
      <button id="findBtn" type="submit">find my party</button>

      <p id="status" class="muted"></p>
      <p id="lookupError" style="display:none;"></p>
    </form>

    <div id="rsvpCard" style="display:none; width:100%;">
      <h2 id="partyLabel"></h2>
      <p id="partyMeta" class="muted"></p>

      <a href="#" id="startOverBtn" class="small-box-link" style="margin-top: 0.75rem;">start over</a>

      <div id="guestList" style="margin-top: 1rem;"></div>

      <div id="rsvpActions" style="margin-top: 1.25rem; display:flex; flex-direction:column; align-items:center;">
        <button id="saveBtn" type="button">save RSVP</button>
        <p id="saveStatus" class="muted"></p>
        <p id="saveError" style="display:none;"></p>
        <p id="saveSuccess" style="display:none;">saved! thank you.</p>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://pdtitxnlpgebzfulnsac.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_7_cRJ3liQkWWnckseJunwQ_CGHG_xIC";

    // âœ… FIXED: use variables (strings)
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elements
    const lookupForm = document.getElementById("lookupForm");
    const firstNameEl = document.getElementById("firstName");
    const lastNameEl = document.getElementById("lastName");
    const zipEl = document.getElementById("zip");
    const findBtn = document.getElementById("findBtn");
    const statusEl = document.getElementById("status");
    const lookupErrorEl = document.getElementById("lookupError");

    const rsvpCard = document.getElementById("rsvpCard");
    const partyLabelEl = document.getElementById("partyLabel");
    const partyMetaEl = document.getElementById("partyMeta");
    const guestListEl = document.getElementById("guestList");

    const startOverBtn = document.getElementById("startOverBtn");
    const saveBtn = document.getElementById("saveBtn");
    const saveStatusEl = document.getElementById("saveStatus");
    const saveErrorEl = document.getElementById("saveError");
    const saveSuccessEl = document.getElementById("saveSuccess");

    // State
    let selectedParty = null;
    let guestsInParty = [];

    function normalizeName(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z\s'-]/g, "")
        .replace(/\s+/g, " ");
    }

    function normalizeZip(s) {
      return (s || "").trim();
    }

    function setLookupError(msg) {
      lookupErrorEl.textContent = msg;
      lookupErrorEl.style.display = msg ? "block" : "none";
    }

    function setSaveError(msg) {
      saveErrorEl.textContent = msg;
      saveErrorEl.style.display = msg ? "block" : "none";
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function resetUI() {
      statusEl.textContent = "";
      setLookupError("");
      setSaveError("");
      saveStatusEl.textContent = "";
      saveSuccessEl.style.display = "none";
      rsvpCard.style.display = "none";
      guestListEl.innerHTML = "";
      selectedParty = null;
      guestsInParty = [];
    }

    function startOver(e) {
      if (e) e.preventDefault();
      resetUI();
      firstNameEl.value = "";
      lastNameEl.value = "";
      zipEl.value = "";
      firstNameEl.focus();
    }

    function renderPartyAndGuests() {
      partyLabelEl.textContent = (selectedParty?.label || "your party").toUpperCase();
      partyMetaEl.textContent = `zip: ${selectedParty?.zip ?? ""}`;

      guestListEl.innerHTML = "";
      guestsInParty.forEach((g) => {
        const attendingVal = (g.attending === true) ? "yes" : (g.attending === false) ? "no" : "";

        const div = document.createElement("div");
        div.className = "guest";
        div.dataset.guestId = g.id;

        div.innerHTML = `
          <h2>${escapeHtml(g.display_name || "guest")}</h2>

          <div class="attending" role="group" aria-label="attending">
            <label style="display:flex; gap:.5rem; align-items:center; margin:0;">
              <input type="radio" name="attending-${g.id}" value="yes" ${attendingVal === "yes" ? "checked" : ""}>
              yes
            </label>
            <label style="display:flex; gap:.5rem; align-items:center; margin:0;">
              <input type="radio" name="attending-${g.id}" value="no" ${attendingVal === "no" ? "checked" : ""}>
              no
            </label>
          </div>

          <label for="diet-${g.id}">dietary restrictions</label>
          <textarea id="diet-${g.id}" placeholder="e.g., vegetarian, nut allergy">${escapeHtml(g.dietary_restrictions || "")}</textarea>

          <label for="notes-${g.id}">notes</label>
          <textarea id="notes-${g.id}" placeholder="anything else we should know?">${escapeHtml(g.guest_notes || "")}</textarea>
        `;

        guestListEl.appendChild(div);
      });

      rsvpCard.style.display = "block";
      saveSuccessEl.style.display = "none";
      setSaveError("");
      saveStatusEl.textContent = "";
    }

    async function findPartyByNameAndZip() {
      resetUI();

      const firstNorm = normalizeName(firstNameEl.value);
      const lastNorm = normalizeName(lastNameEl.value);
      const zip = normalizeZip(zipEl.value);

      if (!firstNorm) return setLookupError("please enter a first name.");
      if (!lastNorm) return setLookupError("please enter a last name.");
      if (!zip) return setLookupError("please enter a zip code.");

      findBtn.disabled = true;
      statusEl.textContent = "searching...";

      try {
        const { data: matches, error: matchErr } = await supabaseClient
          .from("guests")
          .select(`
            id,
            party_id,
            parties!inner(id, zip, label)
          `)
          .eq("first_name_norm", firstNorm)
          .eq("last_name_norm", lastNorm)
          .eq("parties.zip", zip)
          .limit(2);

        if (matchErr) throw matchErr;

        if (!matches || matches.length === 0) {
          setLookupError("we couldn't find your party. please check spelling + zip and try again.");
          return;
        }

        const partyIds = Array.from(new Set(matches.map(m => m.party_id)));
        if (partyIds.length !== 1) {
          setLookupError("we found multiple possible matches. please contact us for help.");
          return;
        }

        const partyId = partyIds[0];
        selectedParty = matches[0].parties;

        const { data: guests, error: guestsErr } = await supabaseClient
          .from("guests")
          .select("id, party_id, display_name, attending, dietary_restrictions, guest_notes")
          .eq("party_id", partyId)
          .order("id", { ascending: true });

        if (guestsErr) throw guestsErr;

        guestsInParty = guests || [];
        renderPartyAndGuests();

      } catch (e) {
        console.error(e);
        setLookupError("something went wrong while searching. check the console for details.");
      } finally {
        statusEl.textContent = "";
        findBtn.disabled = false;
      }
    }

    async function saveRSVP() {
      setSaveError("");
      saveSuccessEl.style.display = "none";
      saveStatusEl.textContent = "";

      if (!selectedParty?.id) {
        setSaveError("no party loaded.");
        return;
      }

      const guestCards = Array.from(guestListEl.querySelectorAll(".guest"));
      if (!guestCards.length) {
        setSaveError("no guests to update.");
        return;
      }

      saveBtn.disabled = true;
      saveStatusEl.textContent = "saving...";

      try {
        const nowIso = new Date().toISOString();

        const updates = guestCards.map(card => {
          const guestId = card.dataset.guestId;
          const attendingRadio = card.querySelector(`input[name="attending-${guestId}"]:checked`);
          const diet = card.querySelector(`#diet-${guestId}`).value ?? "";
          const notes = card.querySelector(`#notes-${guestId}`).value ?? "";

          let attending = null;
          if (attendingRadio?.value === "yes") attending = true;
          if (attendingRadio?.value === "no") attending = false;

          return {
            id: guestId,
            attending,
            dietary_restrictions: diet.trim() || null,
            guest_notes: notes.trim() || null,
            updated_at: nowIso
          };
        });

        const results = await Promise.all(
          updates.map(u => {
            const { id, ...payload } = u;
            return supabaseClient.from("guests").update(payload).eq("id", id);
          })
        );

        const firstErr = results.map(r => r.error).find(Boolean);
        if (firstErr) throw firstErr;

        const { error: partyErr } = await supabaseClient
          .from("parties")
          .update({ last_rsvp_at: nowIso, updated_at: nowIso })
          .eq("id", selectedParty.id);

        if (partyErr) throw partyErr;

        saveStatusEl.textContent = "";
        saveSuccessEl.style.display = "block";
      } catch (e) {
        console.error(e);
        setSaveError("saving failed. please refresh and try again. (see console for details)");
      } finally {
        saveBtn.disabled = false;
        saveStatusEl.textContent = "";
      }
    }

    // Wire up events
    lookupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      findPartyByNameAndZip();
    });

    saveBtn.addEventListener("click", saveRSVP);
    startOverBtn.addEventListener("click", startOver);
  </script>
</body>
</html>
  </script>
</body>
</html>
